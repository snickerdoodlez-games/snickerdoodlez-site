import{r as u,a as R,T as P,c as Z,j as w,b as ee}from"./index-BPfo5Flo.js";import{L as te,S as se}from"./LevelLayout-B6HclN5D.js";import{g as oe,P as re}from"./ParticleOverlay-Bo7U_dWq.js";const le=({onComplete:M,levelIndex:N,hintsEnabled:y,setHintsEnabled:q,onOpenSettings:E,isReviewing:B,onNext:O})=>{const[d,p]=u.useState([]),[I,x]=u.useState(null),[S,U]=u.useState(!0),[v,$]=u.useState(!1),[k,j]=u.useState(!1),[D,L]=u.useState(0),[A,F]=u.useState(0),[C,J]=u.useState(0),[G,H]=u.useState(0),[V,K]=u.useState(new Set),z=u.useRef(Date.now()),T=u.useRef(Date.now()),W=u.useRef(new Map),b=u.useRef(null),l=3;u.useEffect(()=>{if(k){const n=setTimeout(()=>{j(!1),x(null)},2e3);return()=>clearTimeout(n)}},[k]),u.useEffect(()=>{j(!1),x(null),y&&(T.current=Date.now())},[y]);const Q=u.useMemo(()=>{const n=new Map;return d.forEach(t=>{if(!n.has(t.categoryId)){const i=d.filter(e=>e.categoryId===t.categoryId);n.set(t.categoryId,{name:t.categoryName,isSolved:i.every(e=>e.status==="solved")})}}),Array.from(n.values())},[d]);u.useEffect(()=>{if(S||v)return;const n=new Set;for(let t=0;t<d.length/l;t++){const i=d.slice(t*l,t*l+l);if(i.every(s=>s.status==="solved"))continue;const e={};i.forEach(s=>{e[s.categoryId]=(e[s.categoryId]||0)+1}),Object.values(e).some(s=>s===2)&&n.add(t)}K(n)},[d,S,v]);const _=u.useCallback(n=>{var o;const t=[...n];let i=!1,e=0;const s=t.length/l;for(let a=0;a<s;a++){const c=t.slice(a*l,a*l+l);if(c.every(h=>h.status==="solved")){e++;continue}if(c.every(h=>h.categoryId===c[0].categoryId)){i=!0,e++,R.playRowSolved(),T.current=Date.now(),H(r=>r+1);const h=P[0].solvedColors[a%P[0].solvedColors.length];for(let r=a*l;r<a*l+l;r++){const f=t[r].id,m=(o=W.current.get(f))==null?void 0:o.getBoundingClientRect();m&&b.current&&b.current.explode(m.left+m.width/2,m.top+m.height/2,"#FFFFFF"),t[r]={...t[r],status:"solved",color:h,isSolved:!0}}}}if(i?p(t):F(a=>a+1),e===s&&s>0&&!v){R.playWin(),$(!0);const a=Array.from(new Set(t.map(c=>c.categoryId)));setTimeout(()=>M({timeMs:Date.now()-z.current,hintsUsedCount:C,hintsUsed:C,moves:D,mistakes:A,rowEfficiency:G,solvedCategoryIds:a}),1e3)}},[v,D,M,C,A,G]);u.useEffect(()=>{const n=Z(),i=oe(7,n,3),e=[];for(const s of i)s.words.slice(0,3).forEach(a=>{e.push({id:Math.random().toString(36).substr(2,9),word:a,categoryId:s.id,categoryName:s.name,status:"neutral",isEmoji:!0,isSolved:!1})});p(e.sort(()=>.5-Math.random())),U(!1),L(0),F(0),H(0),z.current=Date.now(),T.current=Date.now()},[N]);const X=()=>{if(v||k||!y)return;const n=d.filter(r=>r.status==="neutral"||r.status==="selected");if(n.length<2)return;const t=Array.from(new Set(n.map(r=>r.categoryId)));if(t.length===0)return;const i=new Map;for(let r=0;r<d.length/l;r++){const m=d.slice(r*l,r*l+l).filter(g=>g.status==="locked");m.length>0&&i.set(m[0].categoryId,r)}let e=t.find(r=>i.has(r));if(e||(e=t[Math.floor(Math.random()*t.length)]),!e)return;const s=n.filter(r=>r.categoryId===e);if(s.length<2)return;const o=s.slice(0,2);let a=i.get(e)??-1;if(a===-1){const r=[];for(let f=0;f<d.length/l;f++){const m=d.slice(f*l,f*l+l);!m.every(g=>g.status==="solved")&&!m.some(g=>g.status==="locked")&&r.push(f)}if(r.length===0)return;a=r[Math.floor(Math.random()*r.length)]}const c=[...d],h=a*l;o.forEach(r=>{let f=-1;for(let g=0;g<l;g++)if(c[h+g].status!=="locked"&&c[h+g].status!=="solved"){f=h+g;break}if(f===-1)return;const m=c.findIndex(g=>g.id===r.id);if(m!==f){const g=c[f];c[f]={...c[m],status:"locked"},c[m]={...g,status:g.status==="locked"?"locked":"neutral"}}else c[f]={...c[f],status:"locked"}}),p(c),R.playTick(),J(r=>r+1),T.current=Date.now(),setTimeout(()=>_(c),50)};u.useEffect(()=>{if(v||S||!y)return;const n=setInterval(()=>{Date.now()-T.current>9e4&&X()},1e3);return()=>clearInterval(n)},[v,S,y,d]);const Y=n=>{if(v||k)return;const t=d.find(i=>i.id===n);if(!(!t||t.status==="solved"||t.status==="locked"))if(I===null)R.playSelect(),x(n),p(i=>i.map(e=>e.id===n?{...e,status:"selected"}:e));else if(I===n)x(null),p(i=>i.map(e=>e.id===n?{...e,status:"neutral"}:e));else{const i=d.findIndex(s=>s.id===I),e=d.findIndex(s=>s.id===n);if(i===-1||e===-1)return;j(!0),L(s=>s+1),R.playSwap(),p(s=>s.map(o=>o.id===I?{...o,status:"swapping"}:o.id===n?{...o,status:"swap-target"}:o)),setTimeout(()=>{p(s=>{const o=[...s],a=o[i],c=o[e];return o[i]={...a,word:c.word,categoryId:c.categoryId,categoryName:c.categoryName,isEmoji:c.isEmoji},o[e]={...c,word:a.word,categoryId:a.categoryId,categoryName:a.categoryName,isEmoji:a.isEmoji},o}),setTimeout(()=>{p(s=>s.map(o=>o.id===I||o.id===n?{...o,status:"fading-out-bg"}:o)),setTimeout(()=>{p(s=>{const o=s.map(a=>a.status==="fading-out-bg"?{...a,status:"neutral"}:a);return setTimeout(()=>_(o),50),o}),x(null),j(!1)},250)},450)},50)}};return S?null:w.jsxs(te,{modeName:"EMOJI",levelIndex:N,onOpenSettings:()=>E==null?void 0:E(Q),isReviewing:B,onNext:O,hintsEnabled:y,onToggleHints:()=>q(!y),children:[w.jsx(re,{ref:b}),w.jsx("div",{className:"flex-1 flex flex-col gap-1.5 overflow-visible pointer-events-auto",children:Array.from({length:d.length/l}).map((n,t)=>{const i=d.slice(t*l,t*l+l),e=i.every(o=>o.status==="solved"),s=V.has(t);return w.jsxs("div",{className:"flex-1 relative min-h-0 overflow-visible",children:[e&&w.jsx(se,{seed:i[0].categoryId}),w.jsx("div",{className:`
                    absolute inset-0 z-0 transition-opacity duration-500 rounded-medium
                    ${s&&!e?"bg-white/5 border border-white/40 animate-pulse-highlight":"opacity-0"}
                  `}),e&&w.jsx("div",{className:"absolute top-0 left-8 z-[100] transform -translate-y-[calc(100%-4px)]",children:w.jsx("div",{className:"px-3 py-0.5 rounded-t-lg text-[9px] font-black uppercase bg-black border-x-4 border-t-4 border-white text-white whitespace-nowrap",children:i[0].categoryName})}),w.jsx("div",{className:`grid grid-cols-3 gap-1.5 w-full h-full relative z-10 rounded-small transition-all duration-300 ${e?"p-3":"p-1"}`,children:i.map(o=>w.jsx(ee,{data:o,onClick:Y,ref:a=>{a&&W.current.set(o.id,a)}},o.id))})]},t)})})]})};export{le as default};
