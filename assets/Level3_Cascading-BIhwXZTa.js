import{r as n,a as w,T as Z,j as f,b as fe,S as ge}from"./index-D9YckaCJ.js";import{L as me,S as we}from"./LevelLayout-GhVcd8IL.js";import{g as pe,P as he}from"./ParticleOverlay-B0gEOZzq.js";const xe=({csvData:S,onComplete:L,levelIndex:A,hintsEnabled:k,setHintsEnabled:Ie,onOpenSettings:j,isReviewing:ee,onNext:te})=>{const[i,g]=n.useState([]),[x,H]=n.useState([]),[I,v]=n.useState(null),[y,se]=n.useState(!0),[p,P]=n.useState(!1),[F,_]=n.useState(!1),[R,M]=n.useState(!1),[oe,z]=n.useState(0),[B,ae]=n.useState(0),[G,W]=n.useState(0),[V,re]=n.useState(0),[$,O]=n.useState(0),[ne,le]=n.useState(new Set),[U,ce]=n.useState([]),[q,ie]=n.useState(0),T=n.useRef(Date.now()),J=n.useRef(Date.now()),b=n.useRef(new Map),N=n.useRef(null),C=n.useRef(0),E=7,d=4,K=E*d,de=n.useMemo(()=>{const r=[...i,...x],o=new Map;return r.forEach(s=>{s.status!=="placeholder-colored"&&!o.has(s.categoryId)&&o.set(s.categoryId,{name:s.categoryName,isSolved:!1})}),Array.from(o.values()).sort((s,e)=>s.name.localeCompare(e.name))},[i,x]);n.useEffect(()=>{if(y||R||p)return;const r=new Set;for(let o=0;o<E;o++){const s=i.slice(o*d,o*d+d);if(s.length===0||s.every(t=>t.status==="solved")||s.some(t=>t.categoryId==="blank"))continue;const e={};s.forEach(t=>{e[t.categoryId]=(e[t.categoryId]||0)+1}),Object.values(e).some(t=>t===3)&&r.add(o)}le(r)},[i,y,R,p]);const D=n.useCallback(r=>{var e;let o=[...r],s=-1;for(let t=0;t<E;t++){const a=t*d,c=o.slice(a,a+d);if(!(c.some(l=>l.status==="placeholder-colored"||l.status==="solved")||c[0].categoryId==="blank")&&c.every(l=>l.categoryId===c[0].categoryId)){s=t;break}}if(s!==-1){M(!0),w.playRowSolved(),T.current=Date.now();const t=s*d,a=o[t].categoryId;ce(l=>Array.from(new Set([...l,a])));const c=Z[0].solvedColors[q%Z[0].solvedColors.length];ie(l=>l+1);for(let l=0;l<d;l++){const m=o[t+l],u=(e=b.current.get(m.id))==null?void 0:e.getBoundingClientRect();u&&N.current&&N.current.explode(u.left+u.width/2,u.top+u.height/2,"#FFFFFF"),o[t+l]={...o[t+l],status:"solved",color:c}}g(o),C.current-=1,z(C.current),setTimeout(()=>{const l=[...o.slice(0,t),...o.slice(t+d)];let m=[...x];const u=[];for(let X=0;X<d;X++){const Y=m.shift();Y?u.push({...Y,status:"neutral"}):u.push({id:`blank-${Math.random()}`,word:"",categoryId:"blank",categoryName:"",status:"placeholder-colored"})}H(m);const h=[...l,...u];g(h),M(!1),C.current<=0?(P(!0),w.playWin(),setTimeout(()=>{L({timeMs:Date.now()-J.current,hintsUsedCount:$,moves:G,rowsSolved:B,mistakes:V,solvedCategoryIds:[...U,a]})},1e3)):setTimeout(()=>D(h),300)},1200)}},[x,B,G,$,L,V,U,q]);n.useEffect(()=>{if(!S||S.length===0)return;const r=8+Math.floor(Math.random()*6),o=pe(r,S,4);let s=[],e=0;for(const a of o)a.words.slice(0,4).forEach(l=>{s.push({id:Math.random().toString(36).substr(2,9),word:l,categoryId:a.id,categoryName:a.name.includes(":")?a.name.split(":")[1].trim():a.name,status:"neutral"})}),e++;ae(e),z(e),C.current=e;const t=s.sort(()=>.5-Math.random());g(t.slice(0,K)),H(t.slice(K)),se(!1),P(!1),W(0),re(0),M(!1),J.current=Date.now(),T.current=Date.now(),O(0)},[S,A]);const Q=()=>{if(R||F||p)return;const r={};i.forEach(e=>{e.status==="neutral"&&e.categoryId!=="blank"&&(r[e.categoryId]=(r[e.categoryId]||0)+1)});const o=Object.keys(r).find(e=>r[e]===4);if(!o)return;const s=i.filter(e=>e.categoryId===o);g(e=>{const t=[...e],a=0;return s.forEach((c,l)=>{const m=a+l,u=t.findIndex(h=>h.id===c.id);if(u!==m){const h=t[m];t[m]=t[u],t[u]=h}}),setTimeout(()=>D(t),100),t}),w.playTick(),O(e=>e+1),T.current=Date.now()};n.useEffect(()=>{if(p||y||!k)return;const r=setInterval(()=>{Date.now()-T.current>9e4&&Q()},1e3);return()=>clearInterval(r)},[p,y,k,i]);const ue=r=>{if(p||F||R)return;const o=i.findIndex(s=>s.id===r);if(!(o===-1||["placeholder-colored","solved","locked"].includes(i[o].status)))if(I===null)w.playSelect(),v(r),g(s=>s.map(e=>e.id===r?{...e,status:"selected"}:e));else if(I===r)w.playSelect(),v(null),g(s=>s.map(e=>e.id===r?{...e,status:"neutral"}:e));else{const s=i.findIndex(t=>t.id===I),e=i.findIndex(t=>t.id===r);if(s===-1||e===-1){v(null);return}w.playSelect(),g(t=>t.map(a=>a.id===I?{...a,status:"swapping"}:a.id===r?{...a,status:"swap-target"}:a)),setTimeout(()=>{const t=b.current.get(I),a=b.current.get(r);t&&a?(W(c=>c+1),_(!0),w.playSwap(),setTimeout(()=>{const c=[...i],l=c[s];c[s]={...c[e],status:"neutral"},c[e]={...l,status:"neutral"},g(c),v(null),_(!1),D(c)},ge*1e3)):v(null)},50)}};return y?null:f.jsxs(me,{modeName:"HIDDEN TILES",levelIndex:A,onOpenSettings:()=>j==null?void 0:j(de),isReviewing:ee,onNext:te,hintsEnabled:k,onManualHint:Q,rowsLeft:oe,children:[f.jsx(he,{ref:N}),f.jsx("div",{className:"flex-1 w-full flex flex-col gap-1.5 pb-4",children:Array.from({length:E}).map((r,o)=>{const s=i.slice(o*d,o*d+d);if(s.length===0)return null;const e=s.every(a=>a.status==="solved"),t=ne.has(o);return f.jsxs("div",{className:"w-full flex-1 relative min-h-0",children:[e&&f.jsx(we,{seed:s[0].categoryId}),f.jsx("div",{className:`
                        absolute inset-0 z-0 transition-opacity duration-500 rounded-medium
                        ${t&&!e?"bg-white/5 border border-white/40 animate-pulse-highlight":"opacity-0"}
                     `}),e&&f.jsx("div",{className:"absolute top-0 left-8 z-[100] transform -translate-y-[calc(100%-4px)]",children:f.jsx("div",{className:"px-3 py-0.5 rounded-t-lg text-[9px] font-black uppercase border-x-4 border-t-4 border-white font-oswald bg-black text-white whitespace-nowrap",children:s[0].categoryName})}),f.jsx("div",{className:`w-full h-full grid grid-cols-4 gap-1.5 relative z-10 transition-all duration-300 ${e?"p-3 drop-shadow-xl":"p-1"}`,children:s.map(a=>f.jsx(fe,{data:a,onClick:ue,ref:c=>{c&&b.current.set(a.id,c)}},a.id))})]},o)})})]})};export{xe as default};
