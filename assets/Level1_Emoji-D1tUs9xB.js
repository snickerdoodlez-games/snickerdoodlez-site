import{r as u,a as I,T as z,c as X,j as m,b as Y,S as Z}from"./index-D4ccOMr0.js";import{L as ee,S as te}from"./LevelLayout-GgrA-Tz5.js";import{g as se,P as oe}from"./ParticleOverlay-DFPCy2WV.js";const ie=({onComplete:j,levelIndex:M,hintsEnabled:k,setHintsEnabled:ae,onOpenSettings:T,isReviewing:P,onNext:q})=>{const[c,w]=u.useState([]),[x,R]=u.useState(null),[y,B]=u.useState(!0),[h,O]=u.useState(!1),[$,C]=u.useState(!1),[D,N]=u.useState(0),[A,H]=u.useState(0),[L,J]=u.useState(0),[U,V]=u.useState(new Set),F=u.useRef(Date.now()),S=u.useRef(Date.now()),G=u.useRef(new Map),b=u.useRef(null),r=3,K=u.useMemo(()=>{const n=new Map;return c.forEach(s=>{if(!n.has(s.categoryId)){const a=c.filter(t=>t.categoryId===s.categoryId);n.set(s.categoryId,{name:s.categoryName,isSolved:a.every(t=>t.status==="solved")})}}),Array.from(n.values())},[c]);u.useEffect(()=>{if(y||h)return;const n=new Set;for(let s=0;s<c.length/r;s++){const a=c.slice(s*r,s*r+r);if(a.every(e=>e.status==="solved"))continue;const t={};a.forEach(e=>{t[e.categoryId]=(t[e.categoryId]||0)+1}),Object.values(t).some(e=>e===2)&&n.add(s)}V(n)},[c,y,h]);const W=u.useCallback(n=>{var t;const s=[...n];let a=!1;for(let e=0;e<s.length/r;e++){const l=s.slice(e*r,e*r+r);if(!l.every(f=>f.status==="solved")&&l.every(f=>f.categoryId===l[0].categoryId)){a=!0,I.playRowSolved(),S.current=Date.now();const f=z[0].solvedColors[e%z[0].solvedColors.length];for(let o=e*r;o<e*r+r;o++){const i=s[o].id,d=(t=G.current.get(i))==null?void 0:t.getBoundingClientRect();d&&b.current&&b.current.explode(d.left+d.width/2,d.top+d.height/2,"#FFFFFF"),s[o]={...s[o],status:"solved",color:f}}}}if(a?w(s):H(e=>e+1),s.every(e=>e.status==="solved")&&!h){I.playWin(),O(!0);const e=Array.from(new Set(s.map(l=>l.categoryId)));setTimeout(()=>j({timeMs:Date.now()-F.current,hintsUsedCount:L,moves:D,mistakes:A,solvedCategoryIds:e}),1e3)}},[h,D,j,L,A]);u.useEffect(()=>{const n=X(),a=se(7,n,3),t=[];for(const e of a)e.words.slice(0,3).forEach(f=>{t.push({id:Math.random().toString(36).substr(2,9),word:f,categoryId:e.id,categoryName:e.name,status:"neutral",isEmoji:!0})});w(t.sort(()=>.5-Math.random())),B(!1),N(0),H(0),F.current=Date.now(),S.current=Date.now()},[M]);const _=()=>{const n=c.filter(o=>o.status==="neutral"||o.status==="selected");if(n.length<2)return;const s=Array.from(new Set(n.map(o=>o.categoryId)));if(s.length===0)return;const a=new Map;for(let o=0;o<c.length/r;o++){const d=c.slice(o*r,o*r+r).filter(p=>p.status==="locked");d.length>0&&a.set(d[0].categoryId,o)}let t=s.find(o=>a.has(o));if(t||(t=s[Math.floor(Math.random()*s.length)]),!t)return;const e=n.filter(o=>o.categoryId===t);if(e.length<2)return;const l=e.slice(0,2);let f=a.get(t)??-1;if(f===-1){const o=[];for(let i=0;i<c.length/r;i++){const d=c.slice(i*r,i*r+r);!d.every(p=>p.status==="solved")&&!d.some(p=>p.status==="locked")&&o.push(i)}if(o.length===0)return;f=o[Math.floor(Math.random()*o.length)]}w(o=>{const i=[...o],d=f*r;return l.forEach(p=>{let v=-1;for(let g=0;g<r;g++)if(i[d+g].status!=="locked"&&i[d+g].status!=="solved"){v=d+g;break}if(v===-1)return;const E=i.findIndex(g=>g.id===p.id);if(E!==v){const g=i[v];i[v]={...i[E],status:"locked"},i[E]={...g,status:g.status==="locked"?"locked":"neutral"}}else i[v]={...i[v],status:"locked"}}),setTimeout(()=>W(i),50),i}),I.playTick(),J(o=>o+1),S.current=Date.now()};u.useEffect(()=>{if(h||y||!k)return;const n=setInterval(()=>{Date.now()-S.current>9e4&&_()},1e3);return()=>clearInterval(n)},[h,y,k,c]);const Q=n=>{if(h||$)return;const s=c.find(a=>a.id===n);if(!(!s||s.status==="solved"||s.status==="locked"))if(x===null)I.playSelect(),R(n),w(a=>a.map(t=>t.id===n?{...t,status:"selected"}:t));else if(x===n)R(null),w(a=>a.map(t=>t.id===n?{...t,status:"neutral"}:t));else{C(!0),N(e=>e+1),I.playSwap(),w(e=>e.map(l=>l.id===x?{...l,status:"swapping"}:l.id===n?{...l,status:"swap-target"}:l));const a=c.findIndex(e=>e.id===x),t=c.findIndex(e=>e.id===n);setTimeout(()=>{const e=[...c],l=e[a];e[a]={...e[t],status:e[t].status==="locked"?"locked":"neutral",color:void 0},e[t]={...l,status:l.status==="locked"?"locked":"neutral",color:void 0},w(e),R(null),C(!1),setTimeout(()=>W(e),50)},Z*1e3)}};return y?null:m.jsxs(ee,{modeName:"EMOJI",levelIndex:M,onOpenSettings:()=>T==null?void 0:T(K),isReviewing:P,onNext:q,hintsEnabled:k,onManualHint:_,children:[m.jsx(oe,{ref:b}),m.jsx("div",{className:"flex-1 flex flex-col gap-1.5 overflow-visible",children:Array.from({length:c.length/r}).map((n,s)=>{const a=c.slice(s*r,s*r+r),t=a.every(l=>l.status==="solved"),e=U.has(s);return m.jsxs("div",{className:"flex-1 relative min-h-0 overflow-visible",children:[t&&m.jsx(te,{seed:a[0].categoryId}),m.jsx("div",{className:`
                    absolute inset-0 z-0 transition-opacity duration-500 rounded-medium
                    ${e&&!t?"bg-white/5 border border-white/40 animate-pulse-highlight":"opacity-0"}
                  `}),t&&m.jsx("div",{className:"absolute top-0 left-8 z-[100] transform -translate-y-[calc(100%-4px)]",children:m.jsx("div",{className:"px-3 py-0.5 rounded-t-lg text-[9px] font-black uppercase bg-black border-x-4 border-t-4 border-white text-white whitespace-nowrap",children:a[0].categoryName})}),m.jsx("div",{className:`grid grid-cols-3 gap-1.5 w-full h-full relative z-10 rounded-small transition-all duration-300 ${t?"p-3":"p-1"}`,children:a.map(l=>m.jsx(Y,{data:l,onClick:Q,ref:f=>{f&&G.current.set(l.id,f)}},l.id))})]},s)})})]})};export{ie as default};
