import{r as a,a as I,T as ee,j as g,b as we}from"./index-DDsonpNL.js";import{L as pe,S as ye}from"./LevelLayout-Crl5kcUK.js";import{g as ve,P as Ie}from"./ParticleOverlay-DJ29sqSC.js";const Te=({csvData:R,onComplete:F,levelIndex:z,hintsEnabled:y,setHintsEnabled:te,onOpenSettings:D,isReviewing:se,onNext:oe})=>{const[u,f]=a.useState([]),[C,P]=a.useState([]),[h,x]=a.useState(null),[S,ae]=a.useState(!0),[v,_]=a.useState(!1),[B,M]=a.useState(!1),[b,k]=a.useState(!1),[re,G]=a.useState(0),[E,ne]=a.useState(0),[U,V]=a.useState(0),[W,le]=a.useState(0),[L,$]=a.useState(0),[ce,ie]=a.useState(new Set),[O,de]=a.useState([]),[q,ue]=a.useState(0),T=a.useRef(Date.now()),J=a.useRef(Date.now()),K=a.useRef(new Map),A=a.useRef(null),N=a.useRef(0),j=7,d=4,Q=j*d;a.useEffect(()=>{M(!1),k(!1),x(null),y&&(T.current=Date.now())},[y]);const fe=a.useMemo(()=>{const r=[...u,...C],n=new Map;return r.forEach(s=>{s.status!=="placeholder-colored"&&!n.has(s.categoryId)&&n.set(s.categoryId,{name:s.categoryName,isSolved:!1})}),Array.from(n.values()).sort((s,t)=>s.name.localeCompare(t.name))},[u,C]);a.useEffect(()=>{if(S||b||v)return;const r=new Set;for(let n=0;n<j;n++){const s=u.slice(n*d,n*d+d);if(s.length===0||s.every(o=>o.status==="solved")||s.some(o=>o.categoryId==="blank"))continue;const t={};s.forEach(o=>{t[o.categoryId]=(t[o.categoryId]||0)+1}),Object.values(t).some(o=>o===3)&&r.add(n)}ie(r)},[u,S,b,v]);const H=a.useCallback((r,n)=>{var o;let s=[...r],t=-1;for(let e=0;e<j;e++){const l=e*d,c=s.slice(l,l+d);if(!(c.some(m=>m.status==="placeholder-colored"||m.status==="solved")||c[0].categoryId==="blank")&&c.every(m=>m.categoryId===c[0].categoryId)){t=e;break}}if(t!==-1){k(!0),I.playRowSolved(),T.current=Date.now();const e=t*d,l=s[e].categoryId;de(i=>Array.from(new Set([...i,l])));const c=ee[0].solvedColors[q%ee[0].solvedColors.length];ue(i=>i+1);for(let i=0;i<d;i++){const p=s[e+i],w=(o=K.current.get(p.id))==null?void 0:o.getBoundingClientRect();w&&A.current&&A.current.explode(w.left+w.width/2,w.top+w.height/2,"#FFFFFF"),s[e+i]={...s[e+i],status:"solved",color:c,isSolved:!0}}f(s),N.current-=1,G(N.current),setTimeout(()=>{const i=[...s.slice(0,e),...s.slice(e+d)];let p=[...C];const w=[];for(let Y=0;Y<d;Y++){const Z=p.shift();Z?w.push({...Z,status:"neutral"}):w.push({id:`blank-${Math.random()}`,word:"",categoryId:"blank",categoryName:"",status:"placeholder-colored"})}P(p);const X=[...i,...w];f(X),k(!1),N.current<=0?(_(!0),I.playWin(),setTimeout(()=>{F({timeMs:Date.now()-J.current,hintsUsedCount:L,hintsUsed:L,moves:U,rowsSolved:E,mistakes:W,rowEfficiency:E,solvedCategoryIds:[...O,l]})},1e3)):setTimeout(()=>H(X),300)},n||1200)}},[C,E,U,L,F,W,O,q]);a.useEffect(()=>{if(!R||R.length===0)return;const r=8+Math.floor(Math.random()*6),n=ve(r,R,4);let s=[],t=0;for(const e of n)e.words.slice(0,4).forEach(c=>{s.push({id:Math.random().toString(36).substr(2,9),word:c,categoryId:e.id,categoryName:e.name.includes(":")?e.name.split(":")[1].trim():e.name,status:"neutral",isSolved:!1})}),t++;ne(t),G(t),N.current=t;const o=s.sort(()=>.5-Math.random());f(o.slice(0,Q)),P(o.slice(Q)),ae(!1),_(!1),V(0),le(0),k(!1),J.current=Date.now(),T.current=Date.now(),$(0)},[R,z]);const ge=()=>{if(b||B||v||!y)return;const r={};u.forEach(t=>{t.status==="neutral"&&t.categoryId!=="blank"&&(r[t.categoryId]=(r[t.categoryId]||0)+1)});const n=Object.keys(r).find(t=>r[t]===4);if(!n)return;const s=u.filter(t=>t.categoryId===n);f(t=>{const o=[...t],e=0;return s.forEach((l,c)=>{const m=e+c,i=o.findIndex(p=>p.id===l.id);if(i!==m){const p=o[m];o[m]=o[i],o[i]=p}}),setTimeout(()=>H(o,3500),100),o}),I.playTick(),$(t=>t+1),T.current=Date.now()};a.useEffect(()=>{if(v||S||!y)return;const r=setInterval(()=>{Date.now()-T.current>9e4&&ge()},1e3);return()=>clearInterval(r)},[v,S,y,u]);const me=r=>{if(v||B||b)return;const n=u.find(s=>s.id===r);if(!(!n||["placeholder-colored","solved","locked"].includes(n.status)))if(h===null)I.playSelect(),x(r),f(s=>s.map(t=>t.id===r?{...t,status:"selected"}:t));else if(h===r)I.playSelect(),x(null),f(s=>s.map(t=>t.id===r?{...t,status:"neutral"}:t));else{const s=u.findIndex(o=>o.id===h),t=u.findIndex(o=>o.id===r);if(s===-1||t===-1){x(null);return}M(!0),I.playSwap(),V(o=>o+1),f(o=>o.map(e=>e.id===h?{...e,status:"swapping"}:e.id===r?{...e,status:"swap-target"}:e)),setTimeout(()=>{f(o=>{const e=[...o],l=e[s],c=e[t];return e[s]={...l,word:c.word,categoryId:c.categoryId,categoryName:c.categoryName},e[t]={...c,word:l.word,categoryId:l.categoryId,categoryName:l.categoryName},e}),setTimeout(()=>{f(o=>o.map(e=>e.id===h||e.id===r?{...e,status:"fading-out-bg"}:e)),setTimeout(()=>{f(o=>{const e=o.map(l=>l.status==="fading-out-bg"?{...l,status:"neutral"}:l);return setTimeout(()=>H(e),50),e}),x(null),M(!1)},250)},450)},50)}};return S?null:g.jsxs(pe,{modeName:"HIDDEN TILES",levelIndex:z,onOpenSettings:()=>D==null?void 0:D(fe),isReviewing:se,onNext:oe,hintsEnabled:y,onToggleHints:()=>te(!y),rowsLeft:re,children:[g.jsx(Ie,{ref:A}),g.jsx("div",{className:"flex-1 w-full flex flex-col gap-1.5 pb-4",children:Array.from({length:j}).map((r,n)=>{const s=u.slice(n*d,n*d+d);if(s.length===0)return null;const t=s.every(e=>e.status==="solved"),o=ce.has(n);return g.jsxs("div",{className:"w-full flex-1 relative min-h-0",children:[t&&g.jsx(ye,{seed:s[0].categoryId}),g.jsx("div",{className:`
                        absolute inset-0 z-0 transition-opacity duration-500 rounded-medium
                        ${o&&!t?"bg-white/5 border border-white/40 animate-pulse-highlight":"opacity-0"}
                     `}),t&&g.jsx("div",{className:"absolute top-0 left-8 z-[100] transform -translate-y-[calc(100%-4px)]",children:g.jsx("div",{className:"px-3 py-0.5 rounded-t-lg text-[9px] font-black uppercase border-x-4 border-t-4 border-white font-oswald bg-black text-white whitespace-nowrap",children:s[0].categoryName})}),g.jsx("div",{className:`w-full h-full grid grid-cols-4 gap-1.5 relative z-10 transition-all duration-300 ${t?"p-3 drop-shadow-xl":"p-1"}`,children:s.map(e=>g.jsx(we,{data:e,onClick:me,ref:l=>{l&&K.current.set(e.id,l)}},e.id))})]},n)})})]})};export{Te as default};
