import{r as i,a as C,T as K,G as se,g as oe,j as m,b as re}from"./index-DDsonpNL.js";import{L as ae,S as ne}from"./LevelLayout-Crl5kcUK.js";import{g as le,P as ce}from"./ParticleOverlay-DJ29sqSC.js";const fe=({csvData:v,onComplete:P,mode:N,levelIndex:z,hintsEnabled:p,onOpenSettings:b,setHintsEnabled:j,isReviewing:Q,onNext:X})=>{const[d,w]=i.useState([]),[k,S]=i.useState(null),[T,Y]=i.useState(!0),[h,G]=i.useState(!1),[R,M]=i.useState(!1),[A,W]=i.useState(0),[L,_]=i.useState(0),[V,B]=i.useState(0),[H,U]=i.useState(0),[Z,O]=i.useState(new Set),I=i.useRef(Date.now()),$=i.useRef(Date.now()),q=i.useRef(new Map),E=i.useRef(null);i.useEffect(()=>{if(R){const s=setTimeout(()=>{M(!1),S(null)},2e3);return()=>clearTimeout(s)}},[R]),i.useEffect(()=>{M(!1),S(null),p&&(I.current=Date.now())},[p]);const ee=i.useMemo(()=>{const s=new Map;return d.forEach(o=>{if(!s.has(o.categoryId)){const r=d.filter(e=>e.categoryId===o.categoryId);s.set(o.categoryId,{name:o.categoryName,isSolved:r.every(e=>e.status==="solved")})}}),Array.from(s.values())},[d]);i.useEffect(()=>{if(T||h)return;const s=new Set;for(let o=0;o<d.length/4;o++){const r=d.slice(o*4,o*4+4);if(r.every(a=>a.status==="solved"))continue;const e={};r.forEach(a=>{e[a.categoryId]=(e[a.categoryId]||0)+1}),Object.values(e).some(a=>a===3)&&s.add(o)}O(s)},[d,T,h]);const D=i.useCallback(s=>{var t;const o=s.length/4;let r=0;const e=[...s];let a=!1;for(let n=0;n<o;n++){const c=e.slice(n*4,n*4+4);if(c.every(u=>u.status==="solved")){r++;continue}const x=c[0].categoryId;if(c.every(u=>u.categoryId===x)&&x!=="blank"){a=!0,r++,C.playRowSolved(),I.current=Date.now(),B(f=>f+1);const u=K[0].solvedColors[n%K[0].solvedColors.length];for(let f=n*4;f<n*4+4;f++){const g=e[f],y=(t=q.current.get(g.id))==null?void 0:t.getBoundingClientRect();y&&E.current&&E.current.explode(y.left+y.width/2,y.top+y.height/2,"#FFFFFF"),e[f]={...e[f],status:"solved",isSolved:!0,color:u}}}}if(a?w(e):U(n=>n+1),r===o&&o>0&&!h){C.playWin(),G(!0);const n=Array.from(new Set(e.map(c=>c.categoryId)));setTimeout(()=>P({timeMs:Date.now()-$.current,hintsUsedCount:L,hintsUsed:L,moves:A,rowEfficiency:V,mistakes:H,solvedCategoryIds:n}),1e3)}},[h,L,A,P,V,H]);i.useEffect(()=>{if(!v||v.length===0)return;let s=v;N===se.LEVEL_THEMED&&(s=oe(v.length,v).categories);const o=le(7,s,4),r=[];for(const e of o)e.words.slice(0,4).forEach(t=>{r.push({id:Math.random().toString(36).substr(2,9),word:t,categoryId:e.id,categoryName:e.name.includes(":")?e.name.split(":")[1].trim():e.name,status:"neutral",isSolved:!1})});w(r.sort(()=>.5-Math.random())),G(!1),Y(!1),W(0),U(0),$.current=Date.now(),I.current=Date.now(),_(0),B(0)},[v,N,z]);const J=i.useCallback(()=>{if(h||R||!p)return;const s=d.filter(l=>l.status==="neutral"||l.status==="selected");if(s.length<2)return;const o=Array.from(new Set(s.map(l=>l.categoryId)));if(o.length===0)return;const r=new Map;for(let l=0;l<d.length/4;l++){const f=d.slice(l*4,l*4+4).filter(g=>g.status==="locked");f.length>0&&r.set(f[0].categoryId,l)}let e=o.find(l=>r.has(l));if(e||(e=o[Math.floor(Math.random()*o.length)]),!e)return;const a=s.filter(l=>l.categoryId===e);if(a.length<2)return;const t=a.slice(0,2);let n=r.get(e)??-1;if(n===-1){const l=[];for(let u=0;u<d.length/4;u++){const f=d.slice(u*4,u*4+4),g=f.every(F=>F.status==="solved"),y=f.some(F=>F.status==="locked");!g&&!y&&l.push(u)}if(l.length===0)return;n=l[Math.floor(Math.random()*l.length)]}const c=[...d],x=n*4;t.forEach(l=>{let u=-1;for(let g=0;g<4;g++)if(c[x+g].status!=="locked"&&c[x+g].status!=="solved"){u=x+g;break}if(u===-1)return;const f=c.findIndex(g=>g.id===l.id);if(f!==u){const g=c[u];c[u]={...c[f],status:"locked"},c[f]={...g,status:g.status==="locked"?"locked":"neutral"}}else c[u]={...c[u],status:"locked"}}),w(c),C.playTick(),_(l=>l+1),I.current=Date.now(),setTimeout(()=>D(c),50)},[d,h,R,D,p]);i.useEffect(()=>{if(h||T||!p)return;const s=setInterval(()=>{Date.now()-I.current>9e4&&J()},1e3);return()=>clearInterval(s)},[h,T,p,J]);const te=s=>{if(h||R)return;const o=d.find(r=>r.id===s);if(!(!o||o.status==="locked"||o.status==="solved"))if(k===null)C.playSelect(),S(s),w(r=>r.map(e=>e.id===s?{...e,status:"selected"}:e));else if(k===s)S(null),w(r=>r.map(e=>e.id===s?{...e,status:"neutral"}:e));else{const r=d.findIndex(a=>a.id===k),e=d.findIndex(a=>a.id===s);if(r===-1||e===-1)return;M(!0),C.playSwap(),W(a=>a+1),I.current=Date.now(),w(a=>a.map(t=>t.id===k?{...t,status:"swapping"}:t.id===s?{...t,status:"swap-target"}:t)),setTimeout(()=>{w(a=>{const t=[...a],n=t[r],c=t[e];return t[r]={...n,word:c.word,categoryId:c.categoryId,categoryName:c.categoryName},t[e]={...c,word:n.word,categoryId:n.categoryId,categoryName:n.categoryName},t}),setTimeout(()=>{w(a=>a.map(t=>t.id===k||t.id===s?{...t,status:"fading-out-bg"}:t)),setTimeout(()=>{w(a=>{const t=a.map(n=>n.status==="fading-out-bg"?{...n,status:"neutral"}:n);return setTimeout(()=>D(t),50),t}),S(null),M(!1)},250)},450)},50)}};return T?null:m.jsxs(ae,{modeName:N.replace("LEVEL_",""),levelIndex:z,onOpenSettings:()=>b==null?void 0:b(ee),isReviewing:Q,onNext:X,hintsEnabled:p,onToggleHints:()=>j==null?void 0:j(!p),children:[m.jsx(ce,{ref:E}),m.jsx("div",{className:"flex-1 flex flex-col gap-1.5 overflow-visible pointer-events-auto",children:Array.from({length:d.length/4}).map((s,o)=>{const r=d.slice(o*4,o*4+4),e=r.every(t=>t.status==="solved"),a=Z.has(o);return m.jsxs("div",{className:"flex-1 relative min-h-0 overflow-visible",children:[e&&m.jsx(ne,{seed:r[0].categoryId}),m.jsx("div",{className:`
                    absolute inset-0 z-0 transition-opacity duration-500 rounded-medium
                    ${a&&!e?"bg-white/5 border border-white/40 animate-pulse-highlight":"opacity-0"}
                  `}),e&&m.jsx("div",{className:"absolute top-0 left-8 z-[100] transform -translate-y-[calc(100%-4px)]",children:m.jsx("div",{className:"px-3 py-0.5 rounded-t-lg text-[9px] font-black uppercase bg-black border-x-4 border-t-4 border-white text-white whitespace-nowrap",children:r[0].categoryName})}),m.jsx("div",{className:`grid grid-cols-4 gap-1.5 w-full h-full relative z-10 rounded-small transition-all duration-300 ${e?"p-3":"p-1"}`,children:r.map(t=>m.jsx(re,{data:t,onClick:te,ref:n=>{n&&q.current.set(t.id,n)}},t.id))})]},o)})})]})};export{fe as default};
