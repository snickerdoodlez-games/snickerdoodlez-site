import{r as c,a as S,T as q,G as ee,g as te,j as w,b as se}from"./index-D9YckaCJ.js";import{L as oe,S as ae}from"./LevelLayout-GhVcd8IL.js";import{g as re,P as ne}from"./ParticleOverlay-B0gEOZzq.js";const ue=({csvData:v,onComplete:H,mode:T,levelIndex:D,hintsEnabled:b,onOpenSettings:R,setHintsEnabled:le,isReviewing:J,onNext:K})=>{const[d,h]=c.useState([]),[I,C]=c.useState(null),[x,Q]=c.useState(!0),[p,F]=c.useState(!1),[M,P]=c.useState(!1),[z,G]=c.useState(0),[E,A]=c.useState(0),[W,_]=c.useState(0),[V,B]=c.useState(0),[X,Y]=c.useState(new Set),k=c.useRef(Date.now()),U=c.useRef(Date.now()),$=c.useRef(new Map),N=c.useRef(null),Z=c.useMemo(()=>{const n=new Map;return d.forEach(o=>{if(!n.has(o.categoryId)){const a=d.filter(e=>e.categoryId===o.categoryId);n.set(o.categoryId,{name:o.categoryName,isSolved:a.every(e=>e.status==="solved")})}}),Array.from(n.values())},[d]);c.useEffect(()=>{if(x||p)return;const n=new Set;for(let o=0;o<d.length/4;o++){const a=d.slice(o*4,o*4+4);if(a.every(r=>r.status==="solved"))continue;const e={};a.forEach(r=>{e[r.categoryId]=(e[r.categoryId]||0)+1}),Object.values(e).some(r=>r===3)&&n.add(o)}Y(n)},[d,x,p]);const j=c.useCallback(n=>{var s;const o=n.length/4;let a=0;const e=[...n];let r=!1;for(let l=0;l<o;l++){const t=e.slice(l*4,l*4+4);if(t.every(g=>g.status==="solved")){a++;continue}const i=t[0].categoryId;if(t.every(g=>g.categoryId===i)&&i!=="blank"){r=!0,a++,S.playRowSolved(),k.current=Date.now(),_(u=>u+1);const g=q[0].solvedColors[l%q[0].solvedColors.length];for(let u=l*4;u<l*4+4;u++){const y=e[u],f=(s=$.current.get(y.id))==null?void 0:s.getBoundingClientRect();f&&N.current&&N.current.explode(f.left+f.width/2,f.top+f.height/2,"#FFFFFF"),e[u]={...e[u],status:"solved",isSolved:!0,color:g}}}}if(r?h(e):B(l=>l+1),a===o&&o>0&&!p){S.playWin(),F(!0);const l=Array.from(new Set(e.map(t=>t.categoryId)));setTimeout(()=>H({timeMs:Date.now()-U.current,hintsUsedCount:E,hintsUsed:E,moves:z,rowEfficiency:W,mistakes:V,solvedCategoryIds:l}),1e3)}},[p,E,z,H,W,V]);c.useEffect(()=>{if(!v||v.length===0)return;let n=v;T===ee.LEVEL_THEMED&&(n=te(v.length,v).categories);const o=re(7,n,4),a=[];for(const e of o)e.words.slice(0,4).forEach(s=>{a.push({id:Math.random().toString(36).substr(2,9),word:s,categoryId:e.id,categoryName:e.name.includes(":")?e.name.split(":")[1].trim():e.name,status:"neutral",isSolved:!1})});h(a.sort(()=>.5-Math.random())),F(!1),Q(!1),G(0),B(0),U.current=Date.now(),k.current=Date.now(),A(0),_(0)},[v,T,D]);const L=c.useCallback(()=>{if(p||M)return;const n=d.filter(t=>t.status==="neutral"||t.status==="selected");if(n.length<2)return;const o=Array.from(new Set(n.map(t=>t.categoryId)));if(o.length===0)return;const a=new Map;for(let t=0;t<d.length/4;t++){const m=d.slice(t*4,t*4+4).filter(g=>g.status==="locked");m.length>0&&a.set(m[0].categoryId,t)}let e=o.find(t=>a.has(t));if(e||(e=o[Math.floor(Math.random()*o.length)]),!e)return;const r=n.filter(t=>t.categoryId===e);if(r.length<2)return;const s=r.slice(0,2);let l=a.get(e)??-1;if(l===-1){const t=[];for(let i=0;i<d.length/4;i++){const m=d.slice(i*4,i*4+4),g=m.every(y=>y.status==="solved"),u=m.some(y=>y.status==="locked");!g&&!u&&t.push(i)}if(t.length===0)return;l=t[Math.floor(Math.random()*t.length)]}h(t=>{const i=[...t],m=l*4;return s.forEach(g=>{let u=-1;for(let f=0;f<4;f++)if(i[m+f].status!=="locked"&&i[m+f].status!=="solved"){u=m+f;break}if(u===-1)return;const y=i.findIndex(f=>f.id===g.id);if(y!==u){const f=i[u];i[u]={...i[y],status:"locked"},i[y]={...f,status:f.status==="locked"?"locked":"neutral"}}else i[u]={...i[u],status:"locked"}}),setTimeout(()=>j(i),50),i}),S.playTick(),A(t=>t+1),k.current=Date.now()},[d,p,M,j]);c.useEffect(()=>{if(p||x||!b)return;const n=setInterval(()=>{Date.now()-k.current>9e4&&L()},1e3);return()=>clearInterval(n)},[p,x,b,L]);const O=n=>{if(p||M)return;const o=d.find(a=>a.id===n);if(!(!o||o.status==="locked"||o.status==="solved"))if(I===null)S.playSelect(),C(n),h(a=>a.map(e=>e.id===n?{...e,status:"selected"}:e));else if(I===n)C(null),h(a=>a.map(e=>e.id===n?{...e,status:"neutral"}:e));else{const a=d.findIndex(r=>r.id===I),e=d.findIndex(r=>r.id===n);if(a===-1||e===-1)return;P(!0),S.playSwap(),G(r=>r+1),k.current=Date.now(),h(r=>r.map(s=>s.id===I?{...s,status:"swapping"}:s.id===n?{...s,status:"swap-target"}:s)),setTimeout(()=>{h(r=>{const s=[...r],l=s[a],t=s[e];return s[a]={...l,word:t.word,categoryId:t.categoryId,categoryName:t.categoryName},s[e]={...t,word:l.word,categoryId:l.categoryId,categoryName:l.categoryName},s}),setTimeout(()=>{h(r=>r.map(s=>s.id===I||s.id===n?{...s,status:"fading-out-bg"}:s)),setTimeout(()=>{h(r=>{const s=r.map(l=>l.status==="fading-out-bg"?{...l,status:"neutral"}:l);return setTimeout(()=>j(s),50),s}),C(null),P(!1)},250)},400)},400)}};return x?null:w.jsxs(oe,{modeName:T.replace("LEVEL_",""),levelIndex:D,onOpenSettings:()=>R==null?void 0:R(Z),isReviewing:J,onNext:K,hintsEnabled:b,onManualHint:L,children:[w.jsx(ne,{ref:N}),w.jsx("div",{className:"flex-1 flex flex-col gap-1.5 overflow-visible",children:Array.from({length:d.length/4}).map((n,o)=>{const a=d.slice(o*4,o*4+4),e=a.every(s=>s.status==="solved"),r=X.has(o);return w.jsxs("div",{className:"flex-1 relative min-h-0 overflow-visible",children:[e&&w.jsx(ae,{seed:a[0].categoryId}),w.jsx("div",{className:`
                    absolute inset-0 z-0 transition-opacity duration-500 rounded-medium
                    ${r&&!e?"bg-white/5 border border-white/40 animate-pulse-highlight":"opacity-0"}
                  `}),e&&w.jsx("div",{className:"absolute top-0 left-8 z-[100] transform -translate-y-[calc(100%-4px)]",children:w.jsx("div",{className:"px-3 py-0.5 rounded-t-lg text-[9px] font-black uppercase bg-black border-x-4 border-t-4 border-white text-white whitespace-nowrap",children:a[0].categoryName})}),w.jsx("div",{className:`grid grid-cols-4 gap-1.5 w-full h-full relative z-10 rounded-small transition-all duration-300 ${e?"p-3":"p-1"}`,children:a.map(s=>w.jsx(se,{data:s,onClick:O,ref:l=>{l&&$.current.set(s.id,l)}},s.id))})]},o)})})]})};export{ue as default};
